<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LINE 掛號預約示範</title>
  <style>
    /* 簡潔現代風格（純 CSS） */
    :root{
      --bg:#f6f8fa;
      --card:#ffffff;
      --accent:#0f6fff;
      --muted:#6b7280;
      --radius:12px;
      --shadow: 0 6px 20px rgba(16,24,40,0.06);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", Arial;
    }
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg,var(--bg), #eef2ff 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      color:#111827;
    }
    .container{
      width:100%;
      max-width:920px;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:20px;
    }
    header{
      display:flex;
      gap:12px;
      align-items:center;
      margin-bottom:8px;
    }
    header h1{
      margin:0;
      font-size:20px;
    }
    header p{margin:0;color:var(--muted);font-size:13px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .col{flex:1;min-width:180px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    select,input[type="text"],input[type="datetime-local"],button{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #e6e9ef;
      background:white;
      box-sizing:border-box;
      font-size:14px;
    }
    button{
      background:var(--accent);
      color:white;
      border:none;
      cursor:pointer;
      font-weight:600;
      transition:transform .08s ease;
    }
    button:active{transform:scale(.995)}
    .muted{color:var(--muted);font-size:13px;margin-top:8px}
    .card{background:linear-gradient(180deg,#fff,#fbfdff);padding:12px;border-radius:10px;border:1px solid #eff3ff}
    .hint{font-size:13px;color:#065f46}
    .flex-between{display:flex;justify-content:space-between;align-items:center}
    .hidden{display:none}
    .notice{margin-top:12px;padding:10px;border-radius:10px}
    .notice.success{background:#ecfdf5;color:#065f46}
    .notice.error{background:#fff1f2;color:#9f1239}
    footer{margin-top:14px;font-size:12px;color:var(--muted)}
    @media (max-width:640px){
      header{flex-direction:column;align-items:flex-start}
      .row{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>LINE 掛號預約（HTML 範例）</h1>
        <p>在 LIFF 或瀏覽器中測試。填選城市→醫院→科別→時段→送出預約。</p>
      </div>
      <div style="margin-left:auto;text-align:right">
        <div id="profileName" class="muted">尚未連線</div>
        <div style="margin-top:6px">
          <button id="btnOpenLiff" style="padding:6px 10px;background:#00c300;border-radius:8px;border:none;color:white">在 LINE 開啟（LIFF）</button>
        </div>
      </div>
    </header>

    <main>
      <div class="card">
        <div class="row">
          <div class="col">
            <label for="selectCity">選擇縣市</label>
            <select id="selectCity"><option value="">— 請選縣市 —</option></select>
          </div>
          <div class="col">
            <label for="selectHospital">選擇醫院</label>
            <select id="selectHospital"><option value="">— 請選醫院 —</option></select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="col">
            <label for="selectClinic">科別 / 門診</label>
            <select id="selectClinic"><option value="">— 請選科別 —</option></select>
          </div>
          <div class="col">
            <label for="inputDatetime">預約時間</label>
            <input id="inputDatetime" type="datetime-local" />
          </div>
        </div>

        <div class="row" style="align-items:center;margin-top:12px">
          <div style="flex:1">
            <label for="inputNote">備註（可選）</label>
            <input id="inputNote" type="text" placeholder="輸入簡短備註，例如：初診/回診" />
            <div class="muted">系統會以 LINE userId 綁定帳號（若在 LIFF 內，會自動取得）。</div>
          </div>
          <div style="width:220px">
            <label>&nbsp;</label>
            <button id="btnSubmit">送出預約</button>
          </div>
        </div>

        <div id="message" class="notice hidden" role="status"></div>
      </div>

      <div style="margin-top:14px" class="card">
        <div class="flex-between">
          <div>
            <strong>測試資料說明</strong>
            <div class="muted">目前頁面載入內建範例醫院清單。將 <code>HOSPITALS</code> 變數換成實際資料或改成 fetch 後端 /api/hospitals 即可。</div>
          </div>
          <div>
            <button id="btnToggleTest" style="background:#f59e0b;padding:6px 10px;border-radius:8px">切換測試/正式 API</button>
          </div>
        </div>
        <footer>
          <p>提示：請在部署時把 <code>LIFF_ID</code> 與 <code>API_BASE</code> 設為你的值。後端應提供：GET /hospitals、POST /appointments。</p>
        </footer>
      </div>
    </main>
  </div>

  <!-- LIFF SDK（LINE Web SDK）-->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script>
  /***************************************************************
   *  Config (請替換)
   *  - LIFF_ID: 你在 LINE Developers 建立 LIFF 的 LIFF ID
   *  - API_BASE: 後端 API 基底 URL（不含結尾 /）
   ***************************************************************/
  const LIFF_ID = 'YOUR_LIFF_ID_HERE';        // <-- 把這裡換成你的 LIFF ID
  let API_BASE = 'https://your-api.example.com'; // <-- 後端 API URL
  let useMockData = true; // 初始使用範例資料（按鈕可切換）

  /***************************************************************
   * 範例醫院資料（範例格式）
   * 真實情況通常從後端或政府資料取得（每筆可含 id, name, city, clinics）
   ***************************************************************/
  const HOSPITALS = [
    {
      id: 'h-001',
      name: '台北市立示範醫院',
      city: '台北市',
      address: '台北市信義路1段1號',
      phone: '02-1234-5678',
      clinics: [
        { id: 'c-001', name: '內科' },
        { id: 'c-002', name: '外科' },
        { id: 'c-003', name: '婦產科' }
      ]
    },
    {
      id: 'h-002',
      name: '新北市幸福醫院',
      city: '新北市',
      address: '新北市中正路88號',
      phone: '02-8765-4321',
      clinics: [
        { id: 'c-010', name: '牙科' },
        { id: 'c-011', name: '小兒科' }
      ]
    },
    {
      id: 'h-003',
      name: '台中市良友醫院',
      city: '台中市',
      address: '台中市中山路100號',
      phone: '04-9876-5432',
      clinics: [
        { id: 'c-020', name: '皮膚科' },
        { id: 'c-021', name: '復健科' }
      ]
    }
  ];

  /***************************************************************
   * DOM 元件
   ***************************************************************/
  const el = {
    selectCity: document.getElementById('selectCity'),
    selectHospital: document.getElementById('selectHospital'),
    selectClinic: document.getElementById('selectClinic'),
    inputDatetime: document.getElementById('inputDatetime'),
    inputNote: document.getElementById('inputNote'),
    btnSubmit: document.getElementById('btnSubmit'),
    btnOpenLiff: document.getElementById('btnOpenLiff'),
    btnToggleTest: document.getElementById('btnToggleTest'),
    profileName: document.getElementById('profileName'),
    message: document.getElementById('message')
  };

  let profile = null;   // 若在 LIFF 內會擁有 userId / displayName

  /***************************************************************
   * Helpers
   ***************************************************************/
  function showMessage(text, type='success'){
    el.message.className = `notice ${type}`;
    el.message.textContent = text;
    el.message.classList.remove('hidden');
    // 自動隱藏（6秒）
    setTimeout(()=> el.message.classList.add('hidden'), 6000);
  }

  function setProfileName(name){
    el.profileName.textContent = name ? `Hello, ${name}` : '尚未連線';
  }

  function isoDatetimeLocal(dt){
    // 轉換為 input[type=datetime-local] 可接受字串（瀏覽器本地時間）
    const pad = n => n.toString().padStart(2,'0');
    const y=dt.getFullYear(), m=pad(dt.getMonth()+1), d=pad(dt.getDate());
    const hh=pad(dt.getHours()), mm=pad(dt.getMinutes());
    return `${y}-${m}-${d}T${hh}:${mm}`;
  }

  /***************************************************************
   * 初始化 UI 與事件
   ***************************************************************/
  function populateCities(hospitals){
    const cities = Array.from(new Set(hospitals.map(h=>h.city))).sort();
    el.selectCity.innerHTML = '<option value="">— 請選縣市 —</option>';
    cities.forEach(city=>{
      const opt = document.createElement('option');
      opt.value = city;
      opt.textContent = city;
      el.selectCity.appendChild(opt);
    });
  }

  function populateHospitals(hospitals, city){
    el.selectHospital.innerHTML = '<option value="">— 請選醫院 —</option>';
    hospitals.filter(h=>!city || h.city === city)
      .forEach(h=>{
        const opt = document.createElement('option');
        opt.value = h.id;
        opt.textContent = `${h.name} （${h.address}）`;
        el.selectHospital.appendChild(opt);
      });
    // reset clinics
    el.selectClinic.innerHTML = '<option value="">— 請選科別 —</option>';
  }

  function populateClinics(hospitals, hospitalId){
    const hospital = hospitals.find(h=>h.id === hospitalId);
    el.selectClinic.innerHTML = '<option value="">— 請選科別 —</option>';
    if(!hospital) return;
    hospital.clinics.forEach(c=>{
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.name;
      el.selectClinic.appendChild(opt);
    });
  }

  el.selectCity.addEventListener('change', ()=> {
    const city = el.selectCity.value;
    if(useMockData) populateHospitals(HOSPITALS, city);
    else fetchHospitals().then(h=> populateHospitals(h, city)).catch(()=>{});
  });

  el.selectHospital.addEventListener('change', ()=> {
    const hid = el.selectHospital.value;
    if(useMockData) populateClinics(HOSPITALS, hid);
    else fetchHospitals().then(h=> populateClinics(h, hid)).catch(()=>{});
  });

  el.btnToggleTest.addEventListener('click', ()=> {
    useMockData = !useMockData;
    el.btnToggleTest.textContent = useMockData ? '切換到正式 API' : '切換到測試資料';
    if(useMockData){
      populateCities(HOSPITALS);
      populateHospitals(HOSPITALS, '');
    } else {
      fetchHospitals().then(h=>{
        populateCities(h);
        populateHospitals(h,'');
      }).catch(err=>{
        console.error(err);
        showMessage('從後端取得醫院清單失敗，請確認 API 可用。', 'error');
      });
    }
  });

  el.btnOpenLiff.addEventListener('click', ()=>{
    // 在非 LIFF 環境下會打開 LIFF 的 deep link（若設定）
    // 建議直接在 LINE 內點開 liff URL 或把此頁掛到 LIFF 的 endpoint
    showMessage('請在 LINE 官方帳號的 LIFF 內開啟此頁面以完整使用 LIFF 功能。', 'success');
  });

  el.btnSubmit.addEventListener('click', async ()=>{
    // 表單驗證
    const hospitalId = el.selectHospital.value;
    const clinicId = el.selectClinic.value;
    const appointmentAt = el.inputDatetime.value;
    if(!hospitalId || !clinicId || !appointmentAt){
      showMessage('請選擇醫院、科別與預約時間。', 'error');
      return;
    }

    // 取得使用者 lineUserId（若在 LIFF 中）
    const lineUserId = profile?.userId || null;
    const payload = {
      userLineId: lineUserId,
      hospitalId,
      clinicId,
      appointmentAt: new Date(appointmentAt).toISOString(),
      note: el.inputNote.value || null
    };

    try {
      if(useMockData){
        console.log('POST /api/appointments mock', payload);
        // 模擬成功回應
        showMessage('已送出（測試模式）！系統將模擬建立預約。', 'success');
        return;
      }
      // 正式模式：送到後端
      const res = await fetch(API_BASE + '/appointments', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!res.ok){
        const txt = await res.text();
        throw new Error(`API 回傳 ${res.status}: ${txt}`);
      }
      const data = await res.json();
      showMessage('預約建立成功！系統已發送確認訊息。', 'success');
      console.log('appointment created', data);
    } catch(err){
      console.error(err);
      showMessage('建立預約時發生錯誤，請稍後再試或聯絡客服。', 'error');
    }
  });

  /***************************************************************
   * 從後端抓醫院清單（若使用正式模式）
   * 後端應提供 GET /hospitals 返回 JSON 陣列 (格式同 HOSPITALS)
   ***************************************************************/
  async function fetchHospitals(){
    const res = await fetch(API_BASE + '/hospitals');
    if(!res.ok) throw new Error('fetch hospitals failed');
    return await res.json();
  }

  /***************************************************************
   * LIFF 初始化（若在 LIFF 內使用）
   ***************************************************************/
  async function initLiff(){
    try {
      await liff.init({ liffId: LIFF_ID });
      if (liff.isInClient()) {
        // 可在 LINE 內取得 profile（需要 openWindow scope）
        try {
          const prof = await liff.getProfile();
          profile = { userId: prof.userId, displayName: prof.displayName, pictureUrl: prof.pictureUrl };
          setProfileName(prof.displayName);
        } catch (e){
          console.warn('無法取得 profile', e);
          setProfileName(null);
        }
      } else {
        // 非 LIFF 環境：顯示為未連線
        setProfileName(null);
      }
    } catch (err){
      console.error('LIFF init failed', err);
      setProfileName(null);
    }
  }

  /***************************************************************
   * 啟動流程
   ***************************************************************/
  (function boot(){
    // 預設載入範例資料
    populateCities(HOSPITALS);
    populateHospitals(HOSPITALS,'');

    // input 預設為明天 09:30
    const dt = new Date();
    dt.setDate(dt.getDate() + 1);
    dt.setHours(9,30,0,0);
    el.inputDatetime.value = isoDatetimeLocal(dt);

    // 嘗試初始化 LIFF（若 LIFF_ID 被替換且在 LINE 內開啟才會成功）
    if (LIFF_ID && LIFF_ID !== 'YOUR_LIFF_ID_HERE') {
      initLiff();
    } else {
      // 未設定 LIFF_ID：顯示提示
      setProfileName(null);
    }
  })();
  </script>
</body>
</html>