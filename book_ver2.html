<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
let HOSPITALS = [];

const el = {
  selectCity: document.getElementById('selectCity'),
  selectHospital: document.getElementById('selectHospital'),
  selectClinic: document.getElementById('selectClinic'),
  selectDoctor: document.getElementById('selectDoctor'),
  inputDatetime: document.getElementById('inputDatetime'),
  inputNote: document.getElementById('inputNote'),
  btnSubmit: document.getElementById('btnSubmit'),
  message: document.getElementById('message'),
  profileName: document.getElementById('profileName'),
  btnOpenLiff: document.getElementById('btnOpenLiff')
};

// === 1ï¸âƒ£ åˆå§‹åŒ– LIFF ===
async function initLiff() {
  try {
    await liff.init({ liffId: "YOUR_LIFF_ID" }); // ğŸ”¹æ”¹æˆä½ è‡ªå·±çš„ LIFF ID
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    const profile = await liff.getProfile();
    el.profileName.textContent = `ğŸ‘¤ ${profile.displayName}`;
  } catch (e) {
    console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', e);
    el.profileName.textContent = 'âŒ ç„¡æ³•é€£ç·š LINE';
  }
}

// === 2ï¸âƒ£ è¼‰å…¥é†«é™¢ JSON ===
async function loadHospitals() {
  try {
    const res = await fetch('/static/hospitals.json'); // Flask / Render éƒ½å¯ç”¨
    HOSPITALS = await res.json();
    populateCities();
  } catch (e) {
    showMessage('âŒ ç„¡æ³•è¼‰å…¥é†«é™¢è³‡æ–™', 'error');
    console.error(e);
  }
}

// === 3ï¸âƒ£ ä¸‹æ‹‰é¸å–®æ§åˆ¶ ===
function populateCities() {
  const cities = [...new Set(HOSPITALS.map(h => h.city))];
  el.selectCity.innerHTML = '<option value="">â€” è«‹é¸ç¸£å¸‚ â€”</option>';
  cities.forEach(c => {
    const o = document.createElement('option');
    o.value = c;
    o.textContent = c;
    el.selectCity.appendChild(o);
  });
  el.selectHospital.innerHTML = '<option>â€” è«‹é¸é†«é™¢ â€”</option>';
  el.selectClinic.innerHTML = '<option>â€” è«‹é¸ç§‘åˆ¥ â€”</option>';
  el.selectDoctor.innerHTML = '<option>â€” è«‹é¸é†«ç”Ÿ â€”</option>';
}

function populateHospitals(city) {
  el.selectHospital.innerHTML = '<option value="">â€” è«‹é¸é†«é™¢ â€”</option>';
  HOSPITALS.filter(h => h.city === city).forEach(h => {
    const o = document.createElement('option');
    o.value = h.id; o.textContent = h.name;
    el.selectHospital.appendChild(o);
  });
  el.selectClinic.innerHTML = '<option>â€” è«‹é¸ç§‘åˆ¥ â€”</option>';
  el.selectDoctor.innerHTML = '<option>â€” è«‹é¸é†«ç”Ÿ â€”</option>';
}

function populateClinics(hid) {
  const h = HOSPITALS.find(x => x.id === hid);
  el.selectClinic.innerHTML = '<option>â€” è«‹é¸ç§‘åˆ¥ â€”</option>';
  el.selectDoctor.innerHTML = '<option>â€” è«‹é¸é†«ç”Ÿ â€”</option>';
  if (!h) return;
  h.clinics.forEach(c => {
    const o = document.createElement('option');
    o.value = c.id; o.textContent = c.name;
    el.selectClinic.appendChild(o);
  });
}

function populateDoctors(hid, cid) {
  const h = HOSPITALS.find(x => x.id === hid);
  const c = h?.clinics.find(x => x.id === cid);
  el.selectDoctor.innerHTML = '<option>â€” è«‹é¸é†«ç”Ÿ â€”</option>';
  if (!c) return;
  c.doctors.forEach(d => {
    const o = document.createElement('option');
    o.value = d.id; o.textContent = d.name;
    el.selectDoctor.appendChild(o);
  });
}

// === 4ï¸âƒ£ æäº¤é ç´„ ===
el.btnSubmit.addEventListener('click', async () => {
  const city = el.selectCity.value,
        h = el.selectHospital.value,
        c = el.selectClinic.value,
        d = el.selectDoctor.value,
        t = el.inputDatetime.value;
  if (!city || !h || !c || !d || !t) {
    showMessage('è«‹å®Œæ•´é¸æ“‡å„é …è³‡æ–™', 'error'); return;
  }

  const msg = `âœ… é ç´„æˆåŠŸï¼
ç¸£å¸‚ï¼š${city}
é†«é™¢ï¼š${el.selectHospital.options[el.selectHospital.selectedIndex].text}
ç§‘åˆ¥ï¼š${el.selectClinic.options[el.selectClinic.selectedIndex].text}
é†«ç”Ÿï¼š${el.selectDoctor.options[el.selectDoctor.selectedIndex].text}
æ™‚é–“ï¼š${t}`;

  showMessage(msg, 'success');

  // è‹¥åœ¨ LINE ä¸­æ‰“é–‹ï¼Œå¯ä»¥å‚³è¨Šæ¯å›å®˜æ–¹å¸³è™Ÿ
  if (liff.isInClient()) {
    await liff.sendMessages([{
      type: 'text',
      text: msg
    }]);
    console.log("âœ… å·²é€å‡ºè‡³ LINE å°è©±");
  }
});

// === 5ï¸âƒ£ é¡¯ç¤ºæç¤ºè¨Šæ¯ ===
function showMessage(msg, type = 'success') {
  el.message.textContent = msg;
  el.message.className = `notice ${type}`;
  el.message.classList.remove('hidden');
  setTimeout(() => el.message.classList.add('hidden'), 4000);
}

// === 6ï¸âƒ£ ç¶å®šäº‹ä»¶ ===
el.selectCity.addEventListener('change', () => populateHospitals(el.selectCity.value));
el.selectHospital.addEventListener('change', () => populateClinics(el.selectHospital.value));
el.selectClinic.addEventListener('change', () => populateDoctors(el.selectHospital.value, el.selectClinic.value));

el.btnOpenLiff.addEventListener('click', () => {
  if (!liff.isInClient()) {
    window.location.href = `https://liff.line.me/YOUR_LIFF_ID`; // ğŸ”¹æ”¹æˆä½ çš„ LIFF ID
  }
});

// === åˆå§‹åŒ– ===
initLiff();
loadHospitals();
</script>