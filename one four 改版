import time
import random
import requests
import pandas as pd
from datetime import datetime
import os

class Job104Spider():
    def __init__(self):
        self.headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Referer': 'https://www.104.com.tw/jobs/search/',
        }

    def search(self, keyword, max_mun=10, filter_params=None, sort_type='ç¬¦åˆåº¦', is_sort_asc=False):
        """æœå°‹è·ç¼ºä¸¦å›å‚³åˆ—è¡¨"""
        jobs_list = []
        url = 'https://www.104.com.tw/jobs/search/api/jobs'
        sort_dict = {'ç¬¦åˆåº¦': '1', 'æ—¥æœŸ': '2', 'ç¶“æ­·': '3', 'å­¸æ­·': '4', 'æ‡‰å¾µäººæ•¸': '7', 'å¾…é‡': '13'}
        
        params = {
            'ro': '0',
            'kwop': '7',
            'keyword': keyword,
            'expansionType': 'area,spec,com,job,wf,wktm',
            'mode': 's',
            'jobsource': '2018indexpoc',
            'order': sort_dict.get(sort_type, '1'),
            'asc': '1' if is_sort_asc else '0',
            'page': 1
        }
        if filter_params:
            params.update(filter_params)

        print(f"é–‹å§‹æœå°‹é—œéµå­—: {keyword}...")

        while len(jobs_list) < max_mun:
            try:
                r = requests.get(url, params=params, headers=self.headers)
                r.raise_for_status()
                resp_data = r.json()
                
                new_jobs = resp_data['data']
                if not new_jobs:
                    break
                
                # è½‰æ›ä¸¦æ¸…ç†æ¯ä¸€ç­†è·ç¼ºè³‡æ–™
                for j in new_jobs:
                    if len(jobs_list) >= max_mun:
                        break
                    jobs_list.append(self.search_job_transform(j))
                
                print(f"å·²å–å¾—ç¬¬ {params['page']} é ï¼Œç´¯è¨ˆ {len(jobs_list)} ç­†è³‡æ–™")

                # ç¿»é åˆ¤æ–·
                total_page = resp_data['metadata']['pagination']['lastPage']
                if params['page'] >= total_page:
                    break
                    
                params['page'] += 1
                time.sleep(random.uniform(1, 2))
                
            except Exception as e:
                print(f"ç™¼ç”ŸéŒ¯èª¤: {e}")
                break

        return jobs_list

    def search_job_transform(self, job_data):
        """æ ¼å¼åŒ–è·ç¼ºè³‡æ–™"""
        job_link = job_data['link']['job']
        job_url = f"https:{job_link}" if job_link.startswith('//') else job_link
        
        return {
            'è·ç¼ºåç¨±': job_data.get('jobName'),
            'å…¬å¸åç¨±': job_data.get('custName'),
            'å·¥ä½œåœ°é»': f"{job_data.get('jobAddrNoDesc')} {job_data.get('jobAddress')}",
            'è–ªè³‡å¾…é‡': job_data.get('salaryDesc'),
            'è–ªè³‡ä¸‹é™': job_data.get('salaryLow'),
            'è–ªè³‡ä¸Šé™': job_data.get('salaryHigh'),
            'æ›´æ–°æ—¥æœŸ': job_data.get('appearDate'),
            'æ‡‰å¾µäººæ•¸': job_data.get('applyCnt'),
            'é€£çµ': job_url
        }

# --- åŸ·è¡Œèˆ‡å­˜æª” ---
if __name__ == "__main__":
    spider = Job104Spider()
    
    # 1. æŠ“å–è³‡æ–™ (ä¾‹å¦‚æœå°‹ Python, æŠ“ 30 ç­†)
    keyword = 'Python'
    job_results = spider.search(keyword, max_mun=30)

    if job_results:
        # 2. å°‡åˆ—è¡¨è½‰æ›æˆ DataFrame
        df = pd.DataFrame(job_results)

        # 3. è¨­å®šå­˜æª”è·¯å¾‘ (å­˜åˆ°ç›®å‰ä½¿ç”¨è€…çš„æ¡Œé¢)
        desktop_path = os.path.join(os.path.expanduser("~"), "Desktop")
        filename = f"104è·ç¼ºæœå°‹_{keyword}_{datetime.now().strftime('%m%d_%H%M')}.xlsx"
        save_path = os.path.join(desktop_path, filename)

        # 4. å­˜æª”
        try:
            df.to_excel(save_path, index=False, engine='openpyxl')
            print("-" * 30)
            print(f"æˆåŠŸï¼æª”æ¡ˆå·²å­˜è‡³: {save_path}")
        except Exception as e:
            print(f"å­˜æª”å¤±æ•—: {e}")
    else:
        print("æœªæœé›†åˆ°ä»»ä½•è³‡æ–™ã€‚")





import time
import random
import requests
import pandas as pd
from datetime import datetime

class Job104TelegramBot():
    def __init__(self, tg_token, tg_chat_id):
        self.headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Referer': 'https://www.104.com.tw/jobs/search/',
        }
        self.tg_token = tg_token
        self.tg_chat_id = tg_chat_id

    def send_tg_message(self, message):
        """ç™¼é€è¨Šæ¯åˆ° Telegram"""
        url = f"https://api.telegram.org/bot{self.tg_token}/sendMessage"
        payload = {
            "chat_id": self.tg_chat_id,
            "text": message,
            "parse_mode": "HTML"
        }
        try:
            requests.post(url, data=payload)
        except Exception as e:
            print(f"Telegram ç™¼é€å¤±æ•—: {e}")

    def search_today_jobs(self, keyword):
        """æœå°‹ç•¶å¤©æ›´æ–°çš„è·ç¼º"""
        url = 'https://www.104.com.tw/jobs/search/api/jobs'
        today_str = datetime.now().strftime('%Y%m%d') # æ ¼å¼å¦‚ 20240520
        
        params = {
            'ro': '0',
            'kwop': '7',
            'keyword': keyword,
            'mode': 's',
            'order': '2', # ä»¥æ—¥æœŸæ’åº
            'asc': '0',   # é™å†ªï¼ˆæ–°çš„åœ¨å‰ï¼‰
            'page': 1
        }

        print(f"æ­£åœ¨æª¢æŸ¥ {keyword} çš„ä»Šæ—¥æ–°è·ç¼º...")
        r = requests.get(url, params=params, headers=self.headers)
        if r.status_code != 200: return []

        all_jobs = r.json().get('data', [])
        today_jobs = []

        for job in all_jobs:
            # 104 çš„ appearDate æ ¼å¼é€šå¸¸æ˜¯ "20240520"
            if job.get('appearDate') == today_str:
                job_url = f"https:{job['link']['job']}"
                msg = (
                    f"<b>ğŸ”¥ æ–°è·ç¼ºé€šçŸ¥: {keyword}</b>\n"
                    f"è·ä½: {job['jobName']}\n"
                    f"å…¬å¸: {job['custName']}\n"
                    f"è–ªè³‡: {job['salaryDesc']}\n"
                    f"åœ°é»: {job['jobAddrNoDesc']}\n"
                    f"<a href='{job_url}'>é»æ“ŠæŸ¥çœ‹è·ç¼º</a>"
                )
                today_jobs.append(msg)
        
        return today_jobs

# --- åŸ·è¡Œå€ ---
if __name__ == "__main__":
    # è«‹å¡«å…¥ä½ çš„ Telegram è³‡è¨Š
    MY_TOKEN = "ä½ çš„_BOT_TOKEN"
    MY_CHAT_ID = "ä½ çš„_CHAT_ID"
    
    bot = Job104TelegramBot(MY_TOKEN, MY_CHAT_ID)
    
    # åŸ·è¡Œæœå°‹
    new_posts = bot.search_today_jobs("Python")
    
    if new_posts:
        print(f"æ‰¾åˆ° {len(new_posts)} ç­†æ–°è·ç¼ºï¼Œæº–å‚™ç™¼é€...")
        for post in new_posts:
            bot.send_tg_message(post)
            time.sleep(1) # é¿å…ç™¼é€éå¿«è¢«é»‘åå–®
    else:
        print("ä»Šå¤©ç›®å‰æ²’æœ‰æ–°è·ç¼ºã€‚")





































import time
import random
import requests
import pandas as pd
from datetime import datetime

class Job104TelegramBot():
    def __init__(self, tg_token, tg_chat_id):
        self.headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Referer': 'https://www.104.com.tw/jobs/search/',
        }
        self.tg_token = tg_token
        self.tg_chat_id = tg_chat_id

    def send_tg_message(self, message):
        """ç™¼é€è¨Šæ¯åˆ° Telegram"""
        url = f"https://api.telegram.org/bot{self.tg_token}/sendMessage"
        payload = {
            "chat_id": self.tg_chat_id,
            "text": message,
            "parse_mode": "HTML"
        }
        try:
            requests.post(url, data=payload)
        except Exception as e:
            print(f"Telegram ç™¼é€å¤±æ•—: {e}")

    def search_today_jobs(self, keyword):
        """æœå°‹ç•¶å¤©æ›´æ–°çš„è·ç¼º"""
        url = 'https://www.104.com.tw/jobs/search/api/jobs'
        today_str = datetime.now().strftime('%Y%m%d') # æ ¼å¼å¦‚ 20240520
        print(f"æ­£åœ¨æª¢æŸ¥ {keyword} çš„ä»Šæ—¥æ–°è·ç¼º...")        
        for i in range(50):
          params = {
              'ro': '0',
              'kwop': '7',
              'keyword': keyword,
              'mode': 's',
              'order': '2', # ä»¥æ—¥æœŸæ’åº
              'asc': '0',   # é™å†ªï¼ˆæ–°çš„åœ¨å‰ï¼‰
              'page': i
          }


          r = requests.get(url, params=params, headers=self.headers)
          print(r.status_code)
          if r.status_code != 200: return []

          all_jobs = r.json().get('data', [])
          # print(all_jobs)
          today_jobs = []

          for job in all_jobs:
              # 104 çš„ appearDate æ ¼å¼é€šå¸¸æ˜¯ "20240520"

              if(job.get('appearDate')==today_str) and 'æ–°ç«¹' in job.get('jobAddrNoDesc'):

                job_link = job['link']['job']
                job_url = f"https:{job_link}" if job_link.startswith('//') else job_link
                msg = (
                    f"<b>ğŸ”¥ æ–°è·ç¼ºé€šçŸ¥: {keyword}</b>\n"
                    f"è·ä½: {job['jobName']}\n"
                    f"å…¬å¸: {job['custName']}\n"
                    f"è–ªè³‡(H): {job['salaryHigh']}\n"
                    f"è–ªè³‡(L): {job['salaryLow']}\n"
                    f"åœ°é»: {job['jobAddrNoDesc']}\n"
                    f"<a href='{job_url}'>é»æ“ŠæŸ¥çœ‹è·ç¼º</a>"
                )
                today_jobs.append(msg)
          time.sleep(1)
        return today_jobs

# --- åŸ·è¡Œå€ ---
if __name__ == "__main__":
    # è«‹å¡«å…¥ä½ çš„ Telegram è³‡è¨Š
    MY_TOKEN = "8528605252:AAFKh8Z_6cXKSylfDnnDWwF57KFQfe0qbbk"
    MY_CHAT_ID = "803300061"
    
    bot = Job104TelegramBot(MY_TOKEN, MY_CHAT_ID)
    
    # åŸ·è¡Œæœå°‹
    while True:
        new_posts = bot.search_today_jobs("å·¥ç¨‹å¸«")
        
        if new_posts:
            print(f"æ‰¾åˆ° {len(new_posts)} ç­†æ–°è·ç¼ºï¼Œæº–å‚™ç™¼é€...")
            for post in new_posts:
                bot.send_tg_message(post)
                time.sleep(1) # é¿å…ç™¼é€éå¿«è¢«é»‘åå–®
        else:
            print("ä»Šå¤©ç›®å‰æ²’æœ‰æ–°è·ç¼ºã€‚")






import time
import random
import requests
import pandas as pd
from datetime import datetime

class Job104TelegramBot():
    def __init__(self, tg_token, tg_chat_id):
        self.headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Referer': 'https://www.104.com.tw/jobs/search/',
        }
        self.tg_token = tg_token
        self.tg_chat_id = tg_chat_id
        # æ–°å¢ï¼šå„²å­˜å·²ç™¼é€éçš„è·ç¼º ID
        self.sent_jobs = set()
        # æ–°å¢ï¼šç´€éŒ„æœ€å¾Œä¸€æ¬¡åŸ·è¡Œçš„æ—¥æœŸ
        self.last_run_date = datetime.now().strftime('%Y%m%d')

    def send_tg_message(self, message):
        """ç™¼é€è¨Šæ¯åˆ° Telegram"""
        url = f"https://api.telegram.org/bot{self.tg_token}/sendMessage"
        payload = {
            "chat_id": self.tg_chat_id,
            "text": message,
            "parse_mode": "HTML"
        }
        try:
            requests.post(url, data=payload)
        except Exception as e:
            print(f"Telegram ç™¼é€å¤±æ•—: {e}")

    def search_today_jobs(self, keyword):
        """æœå°‹ç•¶å¤©æ›´æ–°ä¸”æœªç™¼é€éçš„è·ç¼º"""
        # 1. æª¢æŸ¥æ—¥æœŸæ˜¯å¦è®Šæ›´ï¼Œè‹¥æ˜¯éš”å¤©å‰‡æ¸…ç©ºç´€éŒ„
        current_date = datetime.now().strftime('%Y%m%d')
        if current_date != self.last_run_date:
            print(f"--- åµæ¸¬åˆ°æ–°çš„ä¸€å¤© ({current_date})ï¼Œæ¸…ç©ºèˆŠç´€éŒ„ ---")
            self.sent_jobs.clear()
            self.last_run_date = current_date

        url = 'https://www.104.com.tw/jobs/search/api/jobs'
        today_jobs = []
        
        print(f"æ­£åœ¨æª¢æŸ¥ {keyword} çš„ä»Šæ—¥æ–°è·ç¼º...")        
        
        for i in range(1, 11):  # çˆ¬å–å‰ 10 é é€šå¸¸å°±è¶³å¤ æ¶µè“‹ç•¶æ—¥æ›´æ–°
            params = {
                'ro': '0',
                'kwop': '7',
                'keyword': keyword,
                'mode': 's',
                'order': '2', # ä»¥æ—¥æœŸæ’åº
                'asc': '0',   # é™å†ª
                'page': i
            }

            try:
                r = requests.get(url, params=params, headers=self.headers)
                if r.status_code != 200: 
                    break

                all_jobs = r.json().get('data', {}).get('list', []) # ä¿®æ­£: 104 API çµæ§‹é€šå¸¸åœ¨ data.list
                if not all_jobs:
                    break

                for job in all_jobs:
                    job_id = job.get('jobNo')
                    appear_date = job.get('appearDate')

                    # æ¢ä»¶ï¼šæ˜¯ä»Šå¤©çš„æ—¥æœŸ + åŒ…å«æ–°ç«¹ + å°šæœªç™¼é€é
                    if appear_date == current_date and 'æ–°ç«¹' in job.get('jobAddrNoDesc', ''):
                        if job_id not in self.sent_jobs:
                            job_link = job['link']['job']
                            job_url = f"https:{job_link}" if job_link.startswith('//') else job_link
                            
                            msg = (
                                f"<b>ğŸ”¥ æ–°è·ç¼ºé€šçŸ¥: {keyword}</b>\n"
                                f"è·ä½: {job['jobName']}\n"
                                f"å…¬å¸: {job['custName']}\n"
                                f"è–ªè³‡: {job['salaryDesc']}\n"
                                f"åœ°é»: {job['jobAddrNoDesc']}\n"
                                f"<a href='{job_url}'>é»æ“ŠæŸ¥çœ‹è·ç¼º</a>"
                            )
                            today_jobs.append(msg)
                            # æ¨™è¨˜ç‚ºå·²ç™¼é€
                            self.sent_jobs.add(job_id)
                        
                # å¦‚æœé€™é æœ€å¾Œä¸€å€‹è·ç¼ºæ—¥æœŸå·²ç¶“ä¸æ˜¯ä»Šå¤©ï¼Œå°±å¯ä»¥ææ—©åœæ­¢ç¿»é 
                if all_jobs[-1].get('appearDate') != current_date:
                    break
                    
                time.sleep(random.uniform(1, 2)) # éš¨æ©Ÿå»¶é²é˜²çˆ¬èŸ²åµæ¸¬
            except Exception as e:
                print(f"çˆ¬å–ç™¼ç”ŸéŒ¯èª¤: {e}")
                break

        return today_jobs

# --- åŸ·è¡Œå€ ---
if __name__ == "__main__":
    MY_TOKEN = "YOUR_BOT_TOKEN"
    MY_CHAT_ID = "YOUR_CHAT_ID"
    
    bot = Job104TelegramBot(MY_TOKEN, MY_CHAT_ID)
    
    while True:
        new_posts = bot.search_today_jobs("å·¥ç¨‹å¸«")
        
        if new_posts:
            print(f"æ‰¾åˆ° {len(new_posts)} ç­†ã€Œæ–°ã€è·ç¼ºï¼Œæº–å‚™ç™¼é€...")
            for post in new_posts:
                bot.send_tg_message(post)
                time.sleep(1) 
        else:
            print("ç›®å‰æ²’æœ‰æ–°çš„æœªç™¼é€è·ç¼ºã€‚")
        
        # æ¯éš” 15 åˆ†é˜æœå°‹ä¸€æ¬¡ï¼Œé¿å…éæ–¼é »ç¹
        print("ç­‰å¾… 15 åˆ†é˜å¾Œé€²è¡Œä¸‹ä¸€æ¬¡æª¢æŸ¥...")
        time.sleep(900) 












    def search_today_jobs(self, keyword):
        """æœå°‹ç•¶å¤©æ›´æ–°ä¸”æœªç™¼é€éçš„è·ç¼º"""
        # 1. æª¢æŸ¥æ—¥æœŸæ˜¯å¦è®Šæ›´
        current_date = datetime.now().strftime('%Y%m%d')
        if current_date != self.last_run_date:
            print(f"--- åµæ¸¬åˆ°æ–°çš„ä¸€å¤© ({current_date})ï¼Œæ¸…ç©ºèˆŠç´€éŒ„ ---")
            self.sent_jobs.clear()
            self.last_run_date = current_date

        url = 'https://www.104.com.tw/jobs/search/api/jobs'
        today_jobs = []
        
        print(f"æ­£åœ¨æª¢æŸ¥ {keyword} çš„ä»Šæ—¥æ–°è·ç¼º...")        
        
        for i in range(1, 6):  # å…ˆçˆ¬å‰ 5 é æ¸¬è©¦
            params = {
                'ro': '0',
                'kwop': '7',
                'keyword': keyword,
                'mode': 's',
                'order': '2',
                'asc': '0',
                'page': i
            }

            try:
                r = requests.get(url, params=params, headers=self.headers)
                if r.status_code != 200: 
                    break

                # --- ä¿®æ­£å¾Œçš„è³‡æ–™è®€å–é‚è¼¯ ---
                json_data = r.json()
                
                # å®‰å…¨ç²å– job list
                # æœ‰äº›ç‰ˆæœ¬åœ¨ data['list']ï¼Œæœ‰äº›ç›´æ¥åœ¨ data
                data_content = json_data.get('data', {})
                if isinstance(data_content, dict):
                    all_jobs = data_content.get('list', [])
                else:
                    all_jobs = data_content # å¦‚æœ data ç›´æ¥æ˜¯ list

                if not all_jobs:
                    break

                for job in all_jobs:
                    job_id = job.get('jobNo')
                    appear_date = job.get('appearDate')

                    # ç¯©é¸æ¢ä»¶
                    if appear_date == current_date and 'æ–°ç«¹' in job.get('jobAddrNoDesc', ''):
                        if job_id not in self.sent_jobs:
                            job_link = job['link']['job']
                            job_url = f"https:{job_link}" if job_link.startswith('//') else job_link
                            
                            # è–ªè³‡æ¬„ä½è™•ç†ï¼ˆAPI æ¬„ä½åç¨±æœ‰æ™‚æœƒè®Šå‹•ï¼Œå»ºè­°ç”¨ salaryDescï¼‰
                            salary = job.get('salaryDesc', 'é¢è­°')
                            
                            msg = (
                                f"<b>ğŸ”¥ æ–°è·ç¼ºé€šçŸ¥: {keyword}</b>\n"
                                f"è·ä½: {job['jobName']}\n"
                                f"å…¬å¸: {job['custName']}\n"
                                f"è–ªè³‡: {salary}\n"
                                f"åœ°é»: {job['jobAddrNoDesc']}\n"
                                f"<a href='{job_url}'>é»æ“ŠæŸ¥çœ‹è·ç¼º</a>"
                            )
                            today_jobs.append(msg)
                            self.sent_jobs.add(job_id)
                
                # æª¢æŸ¥æœ€å¾Œä¸€å€‹è·ç¼ºæ—¥æœŸï¼Œè‹¥éæœŸå‰‡åœæ­¢ç¿»é 
                if all_jobs[-1].get('appearDate') != current_date:
                    break
                    
                time.sleep(random.uniform(1, 3)) 
            except Exception as e:
                print(f"è§£æç™¼ç”ŸéŒ¯èª¤: {e}")
                break

        return today_jobs








import time
import random
import requests
import os
from datetime import datetime

class Job104TelegramBot():
    def __init__(self, tg_token):
        self.headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Referer': 'https://www.104.com.tw/jobs/search/',
        }
        self.tg_token = tg_token
        self.db_file = "subscribers.txt"  # å„²å­˜è¨‚é–±è€… ID çš„æª”æ¡ˆ
        self.sent_jobs = set()            # å„²å­˜ä»Šæ—¥å·²ç™¼é€è·ç¼º ID
        self.last_run_date = datetime.now().strftime('%Y%m%d')
        
        # åˆå§‹åŒ–æ™‚å…ˆæ›´æ–°è¨‚é–±è€…æ¸…å–®
        self.update_subscribers()

    def update_subscribers(self):
        """é€é getUpdates æª¢æŸ¥æ˜¯å¦æœ‰æ–°ç”¨æˆ¶å‚³é€ /start"""
        url = f"https://api.telegram.org/bot{self.tg_token}/getUpdates"
        try:
            r = requests.get(url).json()
            if r.get("ok"):
                # è®€å–ç¾æœ‰çš„ ID é˜²æ­¢é‡è¤‡
                existing_ids = set()
                if os.path.exists(self.db_file):
                    with open(self.db_file, "r") as f:
                        existing_ids = set(line.strip() for line in f)

                new_users = False
                for result in r.get("result", []):
                    # åªè¦ç”¨æˆ¶æœ‰äº’å‹•ï¼Œå°±ç²å–å…¶ chat_id
                    chat_id = str(result.get("message", {}).get("chat", {}).get("id"))
                    if chat_id and chat_id not in existing_ids:
                        existing_ids.add(chat_id)
                        new_users = True
                
                # å¦‚æœæœ‰æ–°ç”¨æˆ¶ï¼Œå­˜å…¥æª”æ¡ˆ
                if new_users:
                    with open(self.db_file, "w") as f:
                        for uid in existing_ids:
                            f.write(f"{uid}\n")
                    print(f"è¨‚é–±è€…åå–®å·²æ›´æ–°ï¼Œç›®å‰å…± {len(existing_ids)} äººã€‚")
        except Exception as e:
            print(f"æ›´æ–°è¨‚é–±è€…æ¸…å–®å¤±æ•—: {e}")

    def get_all_subscribers(self):
        """å¾æª”æ¡ˆè®€å–æ‰€æœ‰è¨‚é–±è€… ID"""
        if not os.path.exists(self.db_file):
            return []
        with open(self.db_file, "r") as f:
            return [line.strip() for line in f]

    def broadcast_message(self, message):
        """å°‡è¨Šæ¯ç™¼é€çµ¦æ‰€æœ‰è¨‚é–±è€…"""
        subscribers = self.get_all_subscribers()
        url = f"https://api.telegram.org/bot{self.tg_token}/sendMessage"
        
        for chat_id in subscribers:
            payload = {
                "chat_id": chat_id,
                "text": message,
                "parse_mode": "HTML"
            }
            try:
                requests.post(url, data=payload)
                time.sleep(0.1)  # é¿å…è§¸ç™¼ Telegram é »ç‡é™åˆ¶
            except Exception as e:
                print(f"ç™¼é€çµ¦ {chat_id} å¤±æ•—: {e}")

    def search_today_jobs(self, keyword):
        """æœå°‹è·ç¼ºé‚è¼¯ (å·²åŠ å…¥å»é‡èˆ‡æ—¥æœŸé‡ç½®)"""
        current_date = datetime.now().strftime('%Y%m%d')
        if current_date != self.last_run_date:
            self.sent_jobs.clear()
            self.last_run_date = current_date

        url = 'https://www.104.com.tw/jobs/search/api/jobs'
        new_found_jobs = []
        
        print(f"[{datetime.now().strftime('%H:%M:%S')}] æª¢æŸ¥ {keyword}...")        
        
        for i in range(1, 4): # æª¢æŸ¥å‰3é 
            params = {'ro': '0', 'kwop': '7', 'keyword': keyword, 'mode': 's', 'order': '2', 'asc': '0', 'page': i}
            try:
                r = requests.get(url, params=params, headers=self.headers)
                data_content = r.json().get('data', {})
                all_jobs = data_content.get('list', []) if isinstance(data_content, dict) else data_content
                
                if not all_jobs: break

                for job in all_jobs:
                    job_id = job.get('jobNo')
                    # æ¢ä»¶ï¼šä»Šå¤©æ›´æ–° + æ–°ç«¹ + æ²’ç™¼é
                    if job.get('appearDate') == current_date and 'æ–°ç«¹' in job.get('jobAddrNoDesc', ''):
                        if job_id not in self.sent_jobs:
                            job_link = job['link']['job']
                            job_url = f"https:{job_link}" if job_link.startswith('//') else job_link
                            
                            msg = (
                                f"<b>ğŸ”¥ æ–°è·ç¼º: {job['jobName']}</b>\n"
                                f"å…¬å¸: {job['custName']}\n"
                                f"åœ°é»: {job['jobAddrNoDesc']}\n"
                                f"<a href='{job_url}'>é»æ“ŠæŸ¥çœ‹</a>"
                            )
                            new_found_jobs.append(msg)
                            self.sent_jobs.add(job_id)

                if all_jobs[-1].get('appearDate') != current_date: break
                time.sleep(1)
            except: break

        return new_found_jobs

# --- åŸ·è¡Œå€ ---
if __name__ == "__main__":
    TOKEN = "ä½ çš„_BOT_TOKEN"
    bot = Job104TelegramBot(TOKEN)
    
    print("æ©Ÿå™¨äººå·²å•Ÿå‹•ï¼Œè«‹ç¢ºä¿æ–°ç”¨æˆ¶æ›¾å°æ©Ÿå™¨äººé»æ“Šã€Œ/startã€...")

    while True:
        # 1. å…ˆæ›´æ–°è¨‚é–±è€…åå–® (æª¢æŸ¥æ˜¯å¦æœ‰æ–°äººåŠ å…¥)
        bot.update_subscribers()
        
        # 2. æœå°‹è·ç¼º
        new_posts = bot.search_today_jobs("å·¥ç¨‹å¸«")
        
        # 3. å¦‚æœæœ‰æ–°è·ç¼ºï¼Œå»£æ’­çµ¦æ‰€æœ‰äºº
        if new_posts:
            print(f"æ‰¾åˆ° {len(new_posts)} ç­†æ–°è·ç¼ºï¼Œå»£æ’­ä¸­...")
            for post in new_posts:
                bot.broadcast_message(post)
                time.sleep(1)
        
        time.sleep(600) # æ¯ 10 åˆ†é˜å·¡é‚ä¸€æ¬¡





import time
import random
import requests
import os
from datetime import datetime

class Job104TelegramBot():
    def __init__(self, tg_token):
        self.headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Referer': 'https://www.104.com.tw/jobs/search/',
        }
        self.tg_token = tg_token
        self.db_file = "subscribers.txt"
        self.sent_jobs = set()
        self.last_run_date = datetime.now().strftime('%Y%m%d')
        self.last_update_id = 0  # ç”¨æ–¼è¿½è¹¤å·²è®€å–éçš„è¨Šæ¯ ID

    def update_subscribers_and_reply(self):
        """æª¢æŸ¥æ–°è¨Šæ¯ï¼Œè‹¥æœ‰ /start å‰‡åŠ å…¥åå–®ä¸¦å›è¦†"""
        url = f"https://api.telegram.org/bot{self.tg_token}/getUpdates"
        params = {"offset": self.last_update_id + 1, "timeout": 10}
        
        try:
            r = requests.get(url, params=params).json()
            if r.get("ok"):
                # è®€å–ç¾æœ‰è¨‚é–±è€…
                existing_ids = set()
                if os.path.exists(self.db_file):
                    with open(self.db_file, "r") as f:
                        existing_ids = set(line.strip() for line in f)

                for result in r.get("result", []):
                    self.last_update_id = result.get("update_id")
                    message = result.get("message", {})
                    text = message.get("text", "")
                    chat_id = str(message.get("chat", {}).get("id"))
                    username = message.get("from", {}).get("first_name", "Unknown")

                    # ç•¶æ”¶åˆ° /start æ™‚
                    if text == "/start":
                        if chat_id not in existing_ids:
                            existing_ids.add(chat_id)
                            # 1. åŠ å…¥æª”æ¡ˆ
                            with open(self.db_file, "a") as f:
                                f.write(f"{chat_id}\n")
                            
                            # 2. çµ‚ç«¯æ©Ÿå°å‡º
                            print(f"âœ… [æ–°è¨‚é–±è€…] åç¨±: {username}, ID: {chat_id}")

                            # 3. å›è¦†ç”¨æˆ¶
                            welcome_msg = f"ä½ å¥½ {username}ï¼å·²æˆåŠŸè¨‚é–±æ–°ç«¹è·ç¼ºé€šçŸ¥ã€‚ç•¶æœ‰ç¬¦åˆæ¢ä»¶çš„è·ç¼ºæ™‚æœƒå³æ™‚ç™¼é€çµ¦ä½ ã€‚"
                            self.send_direct_message(chat_id, welcome_msg)
                        else:
                            self.send_direct_message(chat_id, "ä½ å·²ç¶“åœ¨è¨‚é–±åå–®ä¸­å›‰ï¼")
        except Exception as e:
            print(f"è™•ç†æ–°ç”¨æˆ¶æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

    def send_direct_message(self, chat_id, text):
        """ç™¼é€å–®ä¸€è¨Šæ¯"""
        url = f"https://api.telegram.org/bot{self.tg_token}/sendMessage"
        payload = {"chat_id": chat_id, "text": text, "parse_mode": "HTML"}
        requests.post(url, data=payload)

    def broadcast_message(self, message):
        """å»£æ’­çµ¦æ‰€æœ‰åå–®å…§çš„äºº"""
        if not os.path.exists(self.db_file): return
        with open(self.db_file, "r") as f:
            subscribers = [line.strip() for line in f]
        
        for chat_id in subscribers:
            self.send_direct_message(chat_id, message)
            time.sleep(0.05)

    def search_today_jobs(self, keyword):
        """æœå°‹è·ç¼ºï¼ˆåŒ…å«æ–°ç«¹ç¯©é¸èˆ‡æ—¥æœŸå»é‡ï¼‰"""
        current_date = datetime.now().strftime('%Y%m%d')
        if current_date != self.last_run_date:
            self.sent_jobs.clear()
            self.last_run_date = current_date

        url = 'https://www.104.com.tw/jobs/search/api/jobs'
        new_found_jobs = []
        print(f"ğŸ” [{datetime.now().strftime('%H:%M:%S')}] å·¡é‚é—œéµå­—: {keyword}")

        for i in range(1, 3):
            params = {'ro': '0', 'kwop': '7', 'keyword': keyword, 'mode': 's', 'order': '2', 'asc': '0', 'page': i}
            try:
                r = requests.get(url, params=params, headers=self.headers)
                data = r.json().get('data', {})
                all_jobs = data.get('list', []) if isinstance(data, dict) else data
                
                if not all_jobs: break
                for job in all_jobs:
                    job_id = job.get('jobNo')
                    if job.get('appearDate') == current_date and 'æ–°ç«¹' in job.get('jobAddrNoDesc', ''):
                        if job_id not in self.sent_jobs:
                            job_link = job['link']['job']
                            job_url = f"https:{job_link}" if job_link.startswith('//') else job_link
                            msg = (
                                f"<b>ğŸ”¥ æ–°è·ç¼º: {job['jobName']}</b>\n"
                                f"å…¬å¸: {job['custName']}\n"
                                f"åœ°é»: {job['jobAddrNoDesc']}\n"
                                f"<a href='{job_url}'>é»æ“ŠæŸ¥çœ‹</a>"
                            )
                            new_found_jobs.append(msg)
                            self.sent_jobs.add(job_id)
                if all_jobs[-1].get('appearDate') != current_date: break
                time.sleep(1)
            except: break
        return new_found_jobs

# --- åŸ·è¡Œå€ ---
if __name__ == "__main__":
    TOKEN = "ä½ çš„_BOT_TOKEN"
    bot = Job104TelegramBot(TOKEN)
    
    print("ğŸš€ æ©Ÿå™¨äººå·²å•Ÿå‹•ï¼Œç›£è½ /start ä¸­...")

    while True:
        # 1. æª¢æŸ¥æ˜¯å¦æœ‰æ–°ç”¨æˆ¶å‚³é€ /start
        bot.update_subscribers_and_reply()
        
        # 2. æœå°‹è·ç¼º (æ­¤è™•ä»¥ä½ çš„å°ˆæ¥­é ˜åŸŸ DFT å·¥ç¨‹å¸«ç‚ºä¾‹)
        new_posts = bot.search_today_jobs("DFT å·¥ç¨‹å¸«")
        
        # 3. å»£æ’­
        if new_posts:
            for post in new_posts:
                bot.broadcast_message(post)
                time.sleep(1)
        
        # æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡ï¼ˆç¸®çŸ­æ™‚é–“ä»¥æå‡ /start çš„åæ‡‰é€Ÿåº¦ï¼‰
        time.sleep(60)

