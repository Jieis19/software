import time
import random
import requests
import pandas as pd
from datetime import datetime
import os

class Job104Spider():
    def __init__(self):
        self.headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Referer': 'https://www.104.com.tw/jobs/search/',
        }

    def search(self, keyword, max_mun=10, filter_params=None, sort_type='ç¬¦åˆåº¦', is_sort_asc=False):
        """æœå°‹è·ç¼ºä¸¦å›å‚³åˆ—è¡¨"""
        jobs_list = []
        url = 'https://www.104.com.tw/jobs/search/api/jobs'
        sort_dict = {'ç¬¦åˆåº¦': '1', 'æ—¥æœŸ': '2', 'ç¶“æ­·': '3', 'å­¸æ­·': '4', 'æ‡‰å¾µäººæ•¸': '7', 'å¾…é‡': '13'}
        
        params = {
            'ro': '0',
            'kwop': '7',
            'keyword': keyword,
            'expansionType': 'area,spec,com,job,wf,wktm',
            'mode': 's',
            'jobsource': '2018indexpoc',
            'order': sort_dict.get(sort_type, '1'),
            'asc': '1' if is_sort_asc else '0',
            'page': 1
        }
        if filter_params:
            params.update(filter_params)

        print(f"é–‹å§‹æœå°‹é—œéµå­—: {keyword}...")

        while len(jobs_list) < max_mun:
            try:
                r = requests.get(url, params=params, headers=self.headers)
                r.raise_for_status()
                resp_data = r.json()
                
                new_jobs = resp_data['data']
                if not new_jobs:
                    break
                
                # è½‰æ›ä¸¦æ¸…ç†æ¯ä¸€ç­†è·ç¼ºè³‡æ–™
                for j in new_jobs:
                    if len(jobs_list) >= max_mun:
                        break
                    jobs_list.append(self.search_job_transform(j))
                
                print(f"å·²å–å¾—ç¬¬ {params['page']} é ï¼Œç´¯è¨ˆ {len(jobs_list)} ç­†è³‡æ–™")

                # ç¿»é åˆ¤æ–·
                total_page = resp_data['metadata']['pagination']['lastPage']
                if params['page'] >= total_page:
                    break
                    
                params['page'] += 1
                time.sleep(random.uniform(1, 2))
                
            except Exception as e:
                print(f"ç™¼ç”ŸéŒ¯èª¤: {e}")
                break

        return jobs_list

    def search_job_transform(self, job_data):
        """æ ¼å¼åŒ–è·ç¼ºè³‡æ–™"""
        job_link = job_data['link']['job']
        job_url = f"https:{job_link}" if job_link.startswith('//') else job_link
        
        return {
            'è·ç¼ºåç¨±': job_data.get('jobName'),
            'å…¬å¸åç¨±': job_data.get('custName'),
            'å·¥ä½œåœ°é»': f"{job_data.get('jobAddrNoDesc')} {job_data.get('jobAddress')}",
            'è–ªè³‡å¾…é‡': job_data.get('salaryDesc'),
            'è–ªè³‡ä¸‹é™': job_data.get('salaryLow'),
            'è–ªè³‡ä¸Šé™': job_data.get('salaryHigh'),
            'æ›´æ–°æ—¥æœŸ': job_data.get('appearDate'),
            'æ‡‰å¾µäººæ•¸': job_data.get('applyCnt'),
            'é€£çµ': job_url
        }

# --- åŸ·è¡Œèˆ‡å­˜æª” ---
if __name__ == "__main__":
    spider = Job104Spider()
    
    # 1. æŠ“å–è³‡æ–™ (ä¾‹å¦‚æœå°‹ Python, æŠ“ 30 ç­†)
    keyword = 'Python'
    job_results = spider.search(keyword, max_mun=30)

    if job_results:
        # 2. å°‡åˆ—è¡¨è½‰æ›æˆ DataFrame
        df = pd.DataFrame(job_results)

        # 3. è¨­å®šå­˜æª”è·¯å¾‘ (å­˜åˆ°ç›®å‰ä½¿ç”¨è€…çš„æ¡Œé¢)
        desktop_path = os.path.join(os.path.expanduser("~"), "Desktop")
        filename = f"104è·ç¼ºæœå°‹_{keyword}_{datetime.now().strftime('%m%d_%H%M')}.xlsx"
        save_path = os.path.join(desktop_path, filename)

        # 4. å­˜æª”
        try:
            df.to_excel(save_path, index=False, engine='openpyxl')
            print("-" * 30)
            print(f"æˆåŠŸï¼æª”æ¡ˆå·²å­˜è‡³: {save_path}")
        except Exception as e:
            print(f"å­˜æª”å¤±æ•—: {e}")
    else:
        print("æœªæœé›†åˆ°ä»»ä½•è³‡æ–™ã€‚")





import time
import random
import requests
import pandas as pd
from datetime import datetime

class Job104TelegramBot():
    def __init__(self, tg_token, tg_chat_id):
        self.headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Referer': 'https://www.104.com.tw/jobs/search/',
        }
        self.tg_token = tg_token
        self.tg_chat_id = tg_chat_id

    def send_tg_message(self, message):
        """ç™¼é€è¨Šæ¯åˆ° Telegram"""
        url = f"https://api.telegram.org/bot{self.tg_token}/sendMessage"
        payload = {
            "chat_id": self.tg_chat_id,
            "text": message,
            "parse_mode": "HTML"
        }
        try:
            requests.post(url, data=payload)
        except Exception as e:
            print(f"Telegram ç™¼é€å¤±æ•—: {e}")

    def search_today_jobs(self, keyword):
        """æœå°‹ç•¶å¤©æ›´æ–°çš„è·ç¼º"""
        url = 'https://www.104.com.tw/jobs/search/api/jobs'
        today_str = datetime.now().strftime('%Y%m%d') # æ ¼å¼å¦‚ 20240520
        
        params = {
            'ro': '0',
            'kwop': '7',
            'keyword': keyword,
            'mode': 's',
            'order': '2', # ä»¥æ—¥æœŸæ’åº
            'asc': '0',   # é™å†ªï¼ˆæ–°çš„åœ¨å‰ï¼‰
            'page': 1
        }

        print(f"æ­£åœ¨æª¢æŸ¥ {keyword} çš„ä»Šæ—¥æ–°è·ç¼º...")
        r = requests.get(url, params=params, headers=self.headers)
        if r.status_code != 200: return []

        all_jobs = r.json().get('data', [])
        today_jobs = []

        for job in all_jobs:
            # 104 çš„ appearDate æ ¼å¼é€šå¸¸æ˜¯ "20240520"
            if job.get('appearDate') == today_str:
                job_url = f"https:{job['link']['job']}"
                msg = (
                    f"<b>ğŸ”¥ æ–°è·ç¼ºé€šçŸ¥: {keyword}</b>\n"
                    f"è·ä½: {job['jobName']}\n"
                    f"å…¬å¸: {job['custName']}\n"
                    f"è–ªè³‡: {job['salaryDesc']}\n"
                    f"åœ°é»: {job['jobAddrNoDesc']}\n"
                    f"<a href='{job_url}'>é»æ“ŠæŸ¥çœ‹è·ç¼º</a>"
                )
                today_jobs.append(msg)
        
        return today_jobs

# --- åŸ·è¡Œå€ ---
if __name__ == "__main__":
    # è«‹å¡«å…¥ä½ çš„ Telegram è³‡è¨Š
    MY_TOKEN = "ä½ çš„_BOT_TOKEN"
    MY_CHAT_ID = "ä½ çš„_CHAT_ID"
    
    bot = Job104TelegramBot(MY_TOKEN, MY_CHAT_ID)
    
    # åŸ·è¡Œæœå°‹
    new_posts = bot.search_today_jobs("Python")
    
    if new_posts:
        print(f"æ‰¾åˆ° {len(new_posts)} ç­†æ–°è·ç¼ºï¼Œæº–å‚™ç™¼é€...")
        for post in new_posts:
            bot.send_tg_message(post)
            time.sleep(1) # é¿å…ç™¼é€éå¿«è¢«é»‘åå–®
    else:
        print("ä»Šå¤©ç›®å‰æ²’æœ‰æ–°è·ç¼ºã€‚")






