é€™æ˜¯ä¸€å€‹å®Œæ•´çš„å°ˆæ¡ˆæ¶æ§‹ï¼Œæˆ‘å°‡å®ƒå‘½åç‚º line-queue-botã€‚é€™å€‹å°ˆæ¡ˆåŒ…å«å¾Œç«¯ (Python Flask) å’Œå‰ç«¯ (HTML/JS + LIFF)ï¼Œä¸¦é‡å° Render å¹³å°é€²è¡Œäº†å„ªåŒ–ã€‚
é€™å€‹ MVP (æœ€å°å¯è¡Œæ€§ç”¢å“) åŒ…å«äº†ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š
 * ç™¼èµ·æ’éšŠ (Host)ï¼šé€é LIFF ç¶²é å»ºç«‹è¨‚å–®ã€‚
 * ç™¼é€æªåœ˜å¡ç‰‡ï¼šè‡ªå‹•å°‡æ¼‚äº®çš„ Flex Message å‚³é€åˆ°èŠå¤©å®¤ã€‚
 * åŠ å…¥æ’éšŠ (Guest)ï¼šé»æ“Šå¡ç‰‡æŒ‰éˆ•ï¼Œé€é LIFF åŠ å…¥è¨‚å–®ã€‚
 * å³æ™‚æ›´æ–°ï¼šå¾Œç«¯å„²å­˜è¨‚å–®ç‹€æ…‹ (æš«å­˜æ–¼è¨˜æ†¶é«”ï¼Œé‡å•Ÿæœƒæ¶ˆå¤±ï¼Œé©åˆæ¸¬è©¦)ã€‚
1. å°ˆæ¡ˆçµæ§‹ (Project Structure)
è«‹åœ¨ä½ çš„é›»è…¦ä¸Šå»ºç«‹ä¸€å€‹è³‡æ–™å¤¾ï¼Œçµæ§‹å¦‚ä¸‹ï¼š
line-queue-bot/
â”œâ”€â”€ app.py                # å¾Œç«¯ä¸»ç¨‹å¼
â”œâ”€â”€ requirements.txt      # å¥—ä»¶ä¾è³´æ¸…å–®
â””â”€â”€ templates/
    â””â”€â”€ liff.html         # å‰ç«¯ LIFF é é¢

2. ç¨‹å¼ç¢¼å¯¦ä½œ
requirements.txt
é€™å‘Šè¨´ Render éœ€è¦å®‰è£å“ªäº›å¥—ä»¶ã€‚
Flask==3.0.0
line-bot-sdk==3.5.0
gunicorn==21.2.0
requests==2.31.0

app.py (å¾Œç«¯æ ¸å¿ƒ)
é€™å€‹æª”æ¡ˆè™•ç† LINE Webhookã€API è«‹æ±‚ä»¥åŠè¨‚å–®é‚è¼¯ã€‚
import os
import uuid
from datetime import datetime
from flask import Flask, request, abort, render_template, jsonify
from linebot.v3 import WebhookHandler
from linebot.v3.exceptions import InvalidSignatureError
from linebot.v3.messaging import (
    Configuration,
    ApiClient,
    MessagingApi,
    ReplyMessageRequest,
    TextMessage,
    FlexMessage,
    FlexContainer
)
from linebot.v3.webhooks import MessageEvent, TextMessageContent

app = Flask(__name__)

# --- è¨­å®šç’°å¢ƒè®Šæ•¸ ---
CHANNEL_ACCESS_TOKEN = os.getenv('CHANNEL_ACCESS_TOKEN')
CHANNEL_SECRET = os.getenv('CHANNEL_SECRET')
LIFF_ID = os.getenv('LIFF_ID')  # æ ¼å¼åƒæ˜¯: 1234567890-AbCdEfGh

if not all([CHANNEL_ACCESS_TOKEN, CHANNEL_SECRET, LIFF_ID]):
    print("è­¦å‘Š: è«‹æª¢æŸ¥ç’°å¢ƒè®Šæ•¸æ˜¯å¦è¨­å®šå®Œæ•´ã€‚")

configuration = Configuration(access_token=CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(CHANNEL_SECRET)

# --- æ¨¡æ“¬è³‡æ–™åº« (In-Memory DB) ---
# åœ¨æ­£å¼ç’°å¢ƒè«‹æ”¹ç”¨ PostgreSQL
# çµæ§‹: { 'group_id': { 'store':Str, 'host_id':Str, 'orders':List, 'status':Str } }
GROUPS = {}

@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers['X-Line-Signature']
    body = request.get_data(as_text=True)
    app.logger.info("Request body: " + body)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return 'OK'

# --- LIFF é é¢å…¥å£ ---
@app.route("/liff")
def liff_entry():
    # åˆ¤æ–·æ˜¯ç™¼èµ·é‚„æ˜¯è·Ÿåœ˜
    group_id = request.args.get('group_id')
    return render_template('liff.html', liff_id=LIFF_ID, group_id=group_id)

# --- API: å»ºç«‹æ’éšŠ (Host) ---
@app.route("/api/create_group", methods=['POST'])
def create_group():
    data = request.json
    user_id = data.get('userId')
    user_name = data.get('userName')
    store_name = data.get('storeName')
    
    group_id = str(uuid.uuid4())[:8] # ç”¢ç”ŸçŸ­ ID
    
    GROUPS[group_id] = {
        'id': group_id,
        'store': store_name,
        'host_id': user_id,
        'host_name': user_name,
        'created_at': datetime.now().strftime("%H:%M"),
        'orders': [],
        'status': 'OPEN'
    }
    
    # å»ºç«‹ Flex Message å¡ç‰‡
    flex_msg = generate_flex_message(GROUPS[group_id])
    
    # é€é API ä¸»å‹•æ¨æ’­çµ¦ Host (Host å†åˆ†äº«å‡ºå») 
    # è¨»ï¼šå…è²»ç‰ˆ LINE Bot ç„¡æ³•ä¸»å‹• Push çµ¦æœªäº’å‹•è€…ï¼Œ
    # å¯¦å‹™ä¸Šé€šå¸¸å»ºè­°åœ¨ LIFF ç”¨ liff.sendMessages ç™¼é€ï¼Œé€™é‚Šç¤ºç¯„å¾Œç«¯å›å‚³é‚è¼¯
    
    return jsonify({
        "status": "success", 
        "group_id": group_id,
        "flex_message": flex_msg
    })

# --- API: åŠ å…¥æ’éšŠ (Guest) ---
@app.route("/api/join_group", methods=['POST'])
def join_group():
    data = request.json
    group_id = data.get('groupId')
    user_name = data.get('userName')
    item = data.get('item')
    
    if group_id not in GROUPS:
        return jsonify({"status": "error", "msg": "è¨‚å–®ä¸å­˜åœ¨æˆ–å·²çµæŸ"}), 404
        
    GROUPS[group_id]['orders'].append({
        'user': user_name,
        'item': item
    })
    
    return jsonify({"status": "success", "current_count": len(GROUPS[group_id]['orders'])})

# --- è¼”åŠ©å‡½å¼: ç”¢ç”Ÿ Flex Message JSON ---
def generate_flex_message(group_data):
    # é€™æ˜¯ä¸€å€‹ç°¡å–®çš„ Flex Message çµæ§‹
    join_url = f"https://liff.line.me/{LIFF_ID}?group_id={group_data['id']}"
    
    bubble = {
        "type": "bubble",
        "hero": {
            "type": "image",
            "url": "https://images.unsplash.com/photo-1561758033-d8f48f85b39e?auto=format&fit=crop&w=600&q=80", # ç¤ºæ„åœ–
            "size": "full",
            "aspectRatio": "20:13",
            "aspectMode": "cover"
        },
        "body": {
            "type": "box",
            "layout": "vertical",
            "contents": [
                {"type": "text", "text": "æ’éšŠæªåœ˜ä¸­ ğŸ”", "weight": "bold", "size": "xl", "color": "#1DB446"},
                {"type": "text", "text": group_data['store'], "weight": "bold", "size": "xxl", "margin": "md"},
                {"type": "text", "text": f"ç™¼èµ·äºº: {group_data['host_name']}", "size": "sm", "color": "#aaaaaa", "wrap": True},
                {"type": "separator", "margin": "xxl"},
                {"type": "box", "layout": "vertical", "margin": "xxl", "spacing": "sm", "contents": [
                    {"type": "box", "layout": "baseline", "spacing": "sm", "contents": [
                        {"type": "text", "text": "æ™‚é–“", "color": "#aaaaaa", "size": "sm", "flex": 1},
                        {"type": "text", "text": group_data['created_at'], "wrap": True, "color": "#666666", "size": "sm", "flex": 5}
                    ]}
                ]}
            ]
        },
        "footer": {
            "type": "box",
            "layout": "vertical",
            "spacing": "sm",
            "contents": [
                {
                    "type": "button",
                    "style": "primary",
                    "height": "sm",
                    "action": {
                        "type": "uri",
                        "label": "æˆ‘è¦è·Ÿåœ˜ +1",
                        "uri": join_url
                    },
                    "color": "#00b900"
                }
            ]
        }
    }
    return bubble

if __name__ == "__main__":
    app.run(debug=True)

templates/liff.html (å‰ç«¯ä»‹é¢)
é€™æ˜¯ä¸€å€‹é›™æ¨¡å¼é é¢ï¼šå¦‚æœæ˜¯ Host æœƒçœ‹åˆ°ã€Œå»ºç«‹è¡¨å–®ã€ï¼Œå¦‚æœæ˜¯ Guest æœƒçœ‹åˆ°ã€Œé»é¤è¡¨å–®ã€ã€‚
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QueueTogether</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background-color: #f5f5f5; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        input, select, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 5px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background-color: #00b900; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:disabled { background-color: #ccc; }
        h2 { color: #333; margin-top: 0; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="card">
        <div id="loading">è¼‰å…¥ä¸­...</div>

        <div id="host-view" class="hidden">
            <h2>ğŸ” ç™¼èµ·æ’éšŠ</h2>
            <input type="text" id="storeName" placeholder="è¼¸å…¥åº—å®¶åç¨± (å¦‚: 50åµ)">
            <button id="createBtn" onclick="createGroup()">å»ºç«‹æªåœ˜å¡ç‰‡</button>
        </div>

        <div id="guest-view" class="hidden">
            <h2>ğŸ“ æˆ‘è¦è·Ÿåœ˜</h2>
            <p id="groupInfo">æ­£åœ¨åŠ å…¥åœ˜è³¼...</p>
            <input type="text" id="orderItem" placeholder="ä½ æƒ³åƒ/å–ä»€éº¼ï¼Ÿ(å¦‚: çå¥¶åŠç³–)">
            <button id="joinBtn" onclick="joinGroup()">é€å‡ºè¨‚å–®</button>
        </div>
    </div>

    <script>
        // å¾å¾Œç«¯å‚³ä¾†çš„è®Šæ•¸
        const LIFF_ID = "{{ liff_id }}"; 
        const GROUP_ID = "{{ group_id }}"; // å¦‚æœæ˜¯ None å‰‡ç‚ºç©ºå­—ä¸²

        async function main() {
            await liff.init({ liffId: LIFF_ID });
            
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }

            const profile = await liff.getProfile();
            window.currentUser = profile;
            document.getElementById('loading').style.display = 'none';

            // åˆ¤æ–·æ¨¡å¼
            if (GROUP_ID && GROUP_ID !== 'None') {
                // è·Ÿåœ˜æ¨¡å¼
                document.getElementById('guest-view').classList.remove('hidden');
                document.getElementById('groupInfo').innerText = `åŠ å…¥è¨‚å–® ID: ${GROUP_ID}`;
            } else {
                // ç™¼èµ·æ¨¡å¼
                document.getElementById('host-view').classList.remove('hidden');
            }
        }

        // Host: å»ºç«‹ç¾¤çµ„ä¸¦ç™¼é€å¡ç‰‡
        async function createGroup() {
            const store = document.getElementById('storeName').value;
            if (!store) return alert('è«‹è¼¸å…¥åº—å®¶åç¨±');

            const res = await fetch('/api/create_group', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    userId: window.currentUser.userId,
                    userName: window.currentUser.displayName,
                    storeName: store
                })
            });
            
            const data = await res.json();
            
            if (data.status === 'success') {
                // ä½¿ç”¨ LIFF API ç›´æ¥åœ¨èŠå¤©å®¤ç™¼é€å¡ç‰‡
                await liff.sendMessages([{
                    type: "flex",
                    altText: "æœ‰äººç™¼èµ·æ’éšŠå›‰ï¼",
                    contents: data.flex_message
                }]);
                liff.closeWindow();
            }
        }

        // Guest: åŠ å…¥è¨‚å–®
        async function joinGroup() {
            const item = document.getElementById('orderItem').value;
            if (!item) return alert('è«‹è¼¸å…¥é¤é»');

            const res = await fetch('/api/join_group', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    groupId: GROUP_ID,
                    userName: window.currentUser.displayName,
                    item: item
                })
            });

            const data = await res.json();
            if (data.status === 'success') {
                alert('æˆåŠŸåŠ å…¥ï¼ç›®å‰äººæ•¸: ' + data.current_count);
                liff.closeWindow();
            } else {
                alert('éŒ¯èª¤: ' + data.msg);
            }
        }

        main();
    </script>
</body>
</html>

3. éƒ¨ç½²èˆ‡è¨­å®šæµç¨‹ (Deployment Steps)
Step 1: æº–å‚™ LINE é–‹ç™¼è€…å¸³è™Ÿ
 * ç™»å…¥ LINE Developers Consoleã€‚
 * å»ºç«‹ä¸€å€‹ Provider å’Œä¸€å€‹ Messaging API Channelã€‚
 * ç²å– Channel Secret å’Œ Channel Access Tokenã€‚
 * å»ºç«‹ä¸€å€‹ LIFF Appï¼š
   * Size é¸æ“‡ Tallã€‚
   * Endpoint URL å…ˆéš¨ä¾¿å¡« (ç­‰ Render éƒ¨ç½²å¥½å†å›ä¾†æ”¹)ã€‚
   * Scopes å‹¾é¸ profile å’Œ openidï¼Œæœ€é‡è¦çš„æ˜¯è¦é–‹å•Ÿ chat_message.write æ¬Šé™ (é€™å…è¨± LIFF ä»£æ›¿ä½¿ç”¨è€…ç™¼é€å¡ç‰‡)ã€‚
 * è¤‡è£½ LIFF IDã€‚
Step 2: éƒ¨ç½²åˆ° Render
 * å°‡ä¸Šè¿°ç¨‹å¼ç¢¼ä¸Šå‚³åˆ° GitHubã€‚
 * åœ¨ Render å»ºç«‹ä¸€å€‹ Web Serviceã€‚
 * Build Command: pip install -r requirements.txt
 * Start Command: gunicorn app:app
 * è¨­å®š Environment Variables (ç’°å¢ƒè®Šæ•¸)ï¼š
   * CHANNEL_ACCESS_TOKEN: (ä½ çš„ token)
   * CHANNEL_SECRET: (ä½ çš„ secret)
   * LIFF_ID: (ä½ çš„ LIFF ID)
Step 3: å›å¡« URL
 * Render éƒ¨ç½²æˆåŠŸå¾Œï¼Œæœƒçµ¦ä½ ä¸€å€‹ URL (ä¾‹å¦‚ https://queue-bot.onrender.com)ã€‚
 * å›åˆ° LINE Developers Consoleï¼š
   * Messaging API > Webhook URL: å¡«å…¥ https://queue-bot.onrender.com/callbackï¼Œä¸¦é–‹å•Ÿ "Use Webhook"ã€‚
   * LIFF > Endpoint URL: å¡«å…¥ https://queue-bot.onrender.com/liffã€‚
4. å¦‚ä½•æ¸¬è©¦
 * åœ¨ LINE ä¸­åŠ å…¥ä½ çš„ Bot å¥½å‹ã€‚
 * ä½ éœ€è¦ä¸€å€‹è§¸ç™¼é»ä¾†é–‹å•Ÿ LIFFã€‚ä½ å¯ä»¥è¨­å®š Bot çš„ã€Œåœ–æ–‡é¸å–® (Rich Menu)ã€ï¼Œé€£çµè¨­ç‚ºä½ çš„ LIFF URL (https://liff.line.me/{ä½ çš„LIFF_ID})ã€‚
 * é»æ“Šé¸å–® -> é–‹å•Ÿç¶²é  -> è¼¸å…¥ã€Œéº¥ç•¶å‹ã€ -> æŒ‰ä¸‹ã€Œå»ºç«‹æªåœ˜ã€ã€‚
 * ä½ çš„èŠå¤©å®¤æ‡‰è©²æœƒé¦¬ä¸Šè·³å‡ºä¸€å¼µæ¼‚äº®çš„å¡ç‰‡ã€‚
 * è«‹æœ‹å‹ (æˆ–ç”¨é›»è…¦ç‰ˆ LINE) é»æ“Šå¡ç‰‡ä¸Šçš„ã€Œæˆ‘è¦è·Ÿåœ˜ã€æŒ‰éˆ•ï¼Œå°±å¯ä»¥é€²è¡Œé»é¤æ¸¬è©¦äº†ï¼
é€™å€‹æ¶æ§‹æ˜¯å®Œå…¨å¯æ“´å……çš„ã€‚ä¸‹ä¸€æ­¥ä½ å¯ä»¥å°‡ GROUPS å­—å…¸æ›æˆ PostgreSQL è³‡æ–™åº«ï¼Œé€™æ¨£è³‡æ–™å°±ä¸æœƒå› ç‚º Render ä¼‘çœ é‡å•Ÿè€Œæ¶ˆå¤±äº†ã€‚ç¥ä½ é–‹ç™¼é †åˆ©ï¼
