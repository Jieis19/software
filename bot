
# A very simple Flask Hello World app for you to get started with...

from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage
from linebot.models.events import FollowEvent


app = Flask(__name__)


#@app.route('/')
#def hello_world():
#    return render_template('index.html')

HANNEL_SECRET = "3e312784b5d0a822c5a2971845084a7e"

CHANNEL_ACCESS_TOKEN = "DDS2tqAC4BKlE8EJMFPL+SrTWbzBiYjUsXK9o6NlPX2h0LbG4wYAPGpMavazrKqUmayd5mxe7oJUEK9zMq8JRq2bpOYnUxCslrHJ5d5+iDRo7JX/sRgWmZw0CVy7+J+8zyzpFwmlea3tFPHRIND0EwdB04t89/1O/w1cDnyilFU="

line_bot_api = LineBotApi(CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(HANNEL_SECRET)

# @app.route("/callback", methods=['POST'])
# def callback():
#     signature = request.headers['X-Line-Signature']
#     body = request.get_data(as_text=True)
#     app.logger.info("Request body: " + body)
#     print("收到 webhook: ",bady)
#     try:
#         handler.handle(body, signature)
#     except InvalidSignatureError:
#         abort(400)

#     return 'OK'

# @handler.add(MessageEvent, message=TextMessage)
# def handle_message(event):
#     user_msg = event.message.text
#     reply_msg = f"你說的是: {user_msg}"
#     line_bot_api.reply_message(
#         event.reply_token,
#         TextSendMessage(text=reply_msg)
#     )

@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers.get('X-Line-Signature', '')
    body = request.get_data(as_text=True)
    print("Request body:", body)  # 日誌，方便除錯
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        print("Invalid signature!")
        abort(400)
    return 'OK'

# 收到文字訊息回覆
@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    line_bot_api.reply_message(
        event.reply_token,
        TextSendMessage(text=f"你說的是: {event.message.text}")
    )

# 收到加好友事件回覆
@handler.add(FollowEvent)
def handle_follow(event):
    line_bot_api.reply_message(
        event.reply_token,
        TextSendMessage(text="謝謝你加我好友！")
    )
