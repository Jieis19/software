# -*- coding: utf-8 -*-
"""
Created on Mon Aug 25 10:45:30 2025

@author: JASONJIE
"""

import http.client,requests,urllib.parse,time

from bs4 import BeautifulSoup
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
import time
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from datetime import datetime
# è¨­å®šç„¡é ­ç€è¦½å™¨é¸é …
chrome_options = Options()
chrome_options.add_argument("--headless")  # å•Ÿç”¨ç„¡é ­æ¨¡å¼
chrome_options.add_argument("--disable-gpu")
chrome_options.add_argument("--no-sandbox")
chrome_options.add_argument("--disable-dev-shm-usage")
chrome_options.add_argument("blink-settings=imagesEnabled=false")
chrome_options.add_argument("user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36")
chrome_options.add_argument('--disable-blink-features=AutomationControlled')  # é¿å…è¢«åµæ¸¬ç‚ºè‡ªå‹•åŒ–å·¥å…·

# åˆå§‹åŒ–ç€è¦½å™¨
driver = webdriver.Chrome(options=chrome_options)
id_number = "O101212231"  # èº«åˆ†è­‰å­—è™Ÿ
birthday_year = "112"     # ç”Ÿæ—¥å¹´
birthday_month = "06"      # ç”Ÿæ—¥æœˆ
birthday_day = "30"        # ç”Ÿæ—¥æ—¥
verify_code = "123456"     # é©—è­‰ç¢¼
# å½è£ç€è¦½å™¨æŒ‡ç´‹ï¼ˆé˜²æ­¢è¢«åµæ¸¬ç‚ºè‡ªå‹•åŒ–ï¼‰
driver.execute_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined})")
def book():
    url = "https://reg.ntuh.gov.tw/WebReg/WebReg/RegByDrName"
    s = "é»ƒç«‹æ°‘"
    # s="å‘¨å®—æ¬£"
    encoded = urllib.parse.quote(s)
    url_number='https://reg.ntuh.gov.tw/WebReg/WebReg/ValidNumerImage?inputText=XDlEQjNCVjNOSDlI'
    
    payload = f'ckbVHosp=T0&ckbVHosp=false&ckbVHosp=CH&ckbVHosp=false&ckbVHosp=false&ckbVHosp=false&ckbVHosp=false&ckbVHosp=false&ckbVHosp=false&selectAll=false&vHospCode=T0&inputString={encoded}&submitButton=%E6%9F%A5%E8%A9%A2%E9%86%AB%E4%BA%8B%E4%BA%BA%E5%93%A1'
    headers = {
        "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
        "accept-encoding": "gzip, deflate, br, zstd",
        "accept-language": "zh-TW,zh;q=0.9",
        "cache-control": "no-cache",
        "connection": "keep-alive",
        "content-length": "269",
        "content-type": "application/x-www-form-urlencoded",
        "cookie": "_ga=GA1.1.728938374.1747291197; _ga_BRDPSTK5BL=GS2.1.s1747291197$o1$g1$t1747291229$j0$l0$h0; Localization.CurrentUICulture=zh-TW; __RequestVerificationToken_L1dlYlJlZw2=dYt2PJTrWxhSY65ymUl7_JCLl7uZlMATLRGRBoXgqKPVbntPN0vV4mL6JMSrBQl-I9W_svd7Y8Pig-cNwYpnx7x_ClFPL5a08NUpCM-45SA1; ASP.NET_SessionId=phqghl0ovr2tqwwqpim21cbm",
        "host": "reg.ntuh.gov.tw",
        "origin": "https://reg.ntuh.gov.tw",
        "pragma": "no-cache",
        "referer": "https://reg.ntuh.gov.tw/WebReg/WebReg/RegByDrName",
        "sec-ch-ua": "\"Google Chrome\";v=\"135\", \"Not-A.Brand\";v=\"8\", \"Chromium\";v=\"135\"",
        "sec-ch-ua-mobile": "?0",
        "sec-ch-ua-platform": "\"Windows\"",
        "sec-fetch-dest": "document",
        "sec-fetch-mode": "navigate",
        "sec-fetch-site": "same-origin",
        "sec-fetch-user": "?1",
        "upgrade-insecure-requests": "1",
        "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36"
    }

    while True:
        try:
            response = requests.post(url, headers=headers, data=payload)
            soup = BeautifulSoup(response.text, 'html.parser')
            # with open(rf'e:\data_down\log.txt', 'w') as files:  
            #     files.write(response.text)
            if s in response.text:
                # å˜—è©¦æ‰¾ã€Œå‰å¾€æ›è™Ÿã€é€£çµ
                link_tag = soup.find('a', string=lambda text: text and 'å‰å¾€æ›è™Ÿ' in text)
                if not link_tag:
                    for a in soup.find_all('a'):
                        if 'å‰å¾€æ›è™Ÿ' in a.get_text():
                            link_tag = a
                            break
    
                if link_tag:


                    # url = "https://reg.ntuh.gov.tw/WebReg/WebReg/ValidNumerImage?inputText=XDlEQjNCVjNOSDlI"
                    # response = requests.get(url,headers)

                    # # å°†å›¾åƒæ•°æ®è½¬æ¢ä¸º PIL å›¾åƒå¯¹è±¡
                    # image = Image.open(io.BytesIO(response.content))

                    # # å›¾åƒé¢„å¤„ç†ï¼ˆä¾‹å¦‚è½¬æ¢ä¸ºç°åº¦å›¾ã€äºŒå€¼åŒ–ï¼‰
                    # image = image.convert('L')  # è½¬æ¢ä¸ºç°åº¦å›¾
                    # threshold = 128
                    # image = image.point(lambda p: p > threshold and 255)  # äºŒå€¼åŒ–

                    # # ä½¿ç”¨ Tesseract OCR è¿›è¡Œè¯†åˆ«
                    # # æ³¨æ„ï¼šéœ€è¦å®‰è£… Tesseract å¹¶é…ç½®ç¯å¢ƒå˜é‡
                    # text = pytesseract.image_to_string(image)

                    # print("è­˜åˆ¥çµæœ:", text.strip())
                    # verify_code=text.strip()
                    print("âœ… æ‰¾åˆ°é€£çµï¼š", 'https://reg.ntuh.gov.tw/WebReg/WebReg/'+link_tag['href'])
                    get_url='https://reg.ntuh.gov.tw/WebReg/WebReg/'+link_tag['href']
                    # æ‰“é–‹ç›®æ¨™ç¶²é ï¼ˆå¿…é ˆæ›¿æ›ç‚ºä½ è‡ªå·±çš„ç¶²å€ï¼‰
                    driver.get(get_url)
                    # print(driver.page_source)
                    img_element = WebDriverWait(driver, 10).until(
                        EC.presence_of_element_located((By.XPATH, "//img[starts-with(@src, 'ValidNumerImage')]"))
                    )
                    
                    # å–å¾— src å±¬æ€§
                    src_value = img_element.get_attribute("src")
                    # print("âœ… img src å€¼ç‚ºï¼š", src_value)
                    response = requests.get(src_value,headers)

                    # å°†å›¾åƒæ•°æ®è½¬æ¢ä¸º PIL å›¾åƒå¯¹è±¡
                    image = Image.open(io.BytesIO(response.content))

                    # å›¾åƒé¢„å¤„ç†ï¼ˆä¾‹å¦‚è½¬æ¢ä¸ºç°åº¦å›¾ã€äºŒå€¼åŒ–ï¼‰
                    image = image.convert('L')  # è½¬æ¢ä¸ºç°åº¦å›¾
                    threshold = 128
                    image = image.point(lambda p: p > threshold and 255)  # äºŒå€¼åŒ–

                    # ä½¿ç”¨ Tesseract OCR è¿›è¡Œè¯†åˆ«
                    # æ³¨æ„ï¼šéœ€è¦å®‰è£… Tesseract å¹¶é…ç½®ç¯å¢ƒå˜é‡
                    text = pytesseract.image_to_string(image)

                    print("è­˜åˆ¥çµæœ:", text.strip())
                    verify_code=text.strip()                    
                    # print("id")
                    driver.find_element(By.ID, "txtInputID").send_keys(id_number)
                    # print("id1")
                    driver.find_element(By.ID, "year").send_keys(birthday_year)
                    driver.find_element(By.ID, "month").send_keys(birthday_month)
                    driver.find_element(By.ID, "day").send_keys(birthday_day)
                    driver.find_element(By.ID, "validText").send_keys(verify_code)
                    # print("id12")
                    # å˜—è©¦æäº¤è¡¨å–®ï¼ˆå‡è¨­æäº¤æŒ‰éˆ•çš„ type ç‚º submit æˆ–æœ‰ onclick äº‹ä»¶ï¼‰
                    # ä½ å¯ä»¥æ ¹æ“šå¯¦éš›æƒ…æ³èª¿æ•´æäº¤æ–¹å¼
                    # WebDriverWait(driver, 10).until(EC.title_contains("patientIdentityConfirm"))
                    # time.sleep(30)
                    # submit_button = driver.find_element(By.ID, "patientIdentityConfirm")
                    # submit_button.click()
                    # print("âœ… è¡¨å–®å·²é€å‡º")
                    try:
                        # æ–¹æ³•ä¸€ï¼šä½¿ç”¨ XPath æ­£ç¢ºèªæ³•
                        # submit_button = driver.find_element(By.XPATH, "//button[@type='submit'] | //input[@type='submit']")

                        # æ–¹æ³•äºŒï¼šä½¿ç”¨ id ç²¾æº–å®šä½
                        # submit_button = driver.find_element(By.ID, "patientIdentityConfirm")
                        # submit_button.click()


                        submit_button = driver.find_element(By.ID, "patientIdentityConfirm")
                        driver.execute_script("arguments[0].click();", submit_button)


                        print("âœ… è¡¨å–®å·²é€å‡º")
                    except Exception as e:
                        print("âŒ æ‰¾ä¸åˆ°é€å‡ºæŒ‰éˆ•ï¼ŒéŒ¯èª¤ï¼š", e)
                    # print("âœ… è¡¨å–®å·²é€å‡º")
                    # å¯é¸ï¼šå°å‡ºç›®å‰é é¢åŸå§‹ç¢¼ç¢ºèªé€å‡ºçµæœ
                    # print(driver.page_source)
                    break
                    driver.quit()
                    break
                else:
                    print("ğŸ”„ æœªæ‰¾åˆ°é€£çµï¼Œ60 ç§’å¾Œé‡è©¦...")
                    time.sleep(60)
    
        except Exception as e:
            print(f"âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")
            time.sleep(3)
# book()

# è¨­å®šåŸ·è¡Œçš„ç›®æ¨™æ™‚é–“
target_time = "2025-08-25 10:00:00"
target_datetime = datetime.strptime(target_time, "%Y-%m-%d %H:%M:%S")

# ç›®å‰æ™‚é–“
current_time = datetime.now()

# è¨ˆç®—éœ€ç­‰å¾…çš„ç§’æ•¸
wait_seconds = (target_datetime - current_time).total_seconds()

if wait_seconds > 0:
    print(f"éœ€è¦ç­‰å¾… {wait_seconds} ç§’")
    time.sleep(wait_seconds)  # ç­‰å¾…è‡³æŒ‡å®šæ™‚é–“
    for i in range(5):
      book()  # åŸ·è¡Œç›®æ¨™å‡½å¼
else:
    print("ç›®æ¨™æ™‚é–“å·²éï¼Œç„¡æ³•åŸ·è¡Œ book()")

